from flask import jsonify, request
from flask_login import login_required, current_user
from app.models.exploit import Exploit
from app import db

# @login_required
# def get_all_exploits():

exploit_types = ['DOS', 'Remote', 'Local', 'Webapps']
    
@login_required
def get_exploit_by_id(exploit_id):
    exploit = Exploit.query.get(exploit_id)
    if(exploit):
        return jsonify({'exploit' : exploit.as_dict()}), 200
    return jsonify({'message' : 'exploit not found'}), 404

# @login_required
# def get_exploit_by_platform():
#     data = request.get_json()
#     exploits = Exploit.query.filter_by(platform=data['platform']).all()
#     return jsonify({'exploits' : [exploit.as_dict() for expoit in exploits]})

# @login_required
# def get_exploit_by_type():
#     data = request.get_json()
#     exploits = Exploit.query.filter_by(platform=data['type']).all()
#     return jsonify({'exploits' : [exploit.as_dict() for expoit in exploits]})
    
# @login_required
# def get_exploit_by_id_is_approved():
#     exploits = Exploit.query.all()
#     exploits = [exploit for exploit in exploits if exploit.isApproved == True]
#     return jsonify({'exploits' : [exploit.as_dict() for expoit in exploits]})

@login_required
def get_exploit_with_params():
    data = {k: v for k, v in request.args.items() if v is not None or v == ''}
    params_list = ['exploitType', 'platform', 'isApproved']
    if data == {}:
        exploits = Exploit.query.all()
        return jsonify({'exploits' : [exploit.as_dict() for exploit in exploits]}), 200
    exploits = Exploit.query.filter_by(**data).all()
    if exploits : 
        return jsonify({'exploits' : [exploit.as_dict() for exploit in exploits]}), 200
    return jsonify({'message' : 'no exploits found'}), 404

@login_required
def create_exploit():
    data = request.get_json() 
    # exploit = Exploit.query.filter_by(exploitName = data['exploitName']).first()
    # if exploit:
    #     return jsonify({'message' : 'exploit already present'}), 409
    if(data['exploitType'] not in exploit_types):
        return jsonify({'message' : 'Exploit Type is Invalid'}), 400
    new_exploit = Exploit(exploitName = data['exploitName'], exploitFile = data['exploitFile'], isApproved = False, description = data['description'], exploitType = data['exploitType'], platform = data['platform'], userId = current_user.id)
    db.session.add(new_exploit)
    db.session.commit()
    return jsonify({'message' : 'exploit created successfully'}), 201

@login_required
def update_exploit(exploit_id):
    exploit = Exploit.query.get(exploit_id)
    if exploit:
        data = request.get_json()
        for key, value in data.items():
            setattr(exploit, key, value)
        db.session.commit()
        return jsonify({'message' : 'Exploit Updated Successfully'}), 200
    return jsonify({'message' : 'Exploit not found'}), 404

@login_required
def delete_exploit(exploit_id):
    exploit = Exploit.query.get(exploit_id)
    if exploit : 
        db.session.delete(exploit)
        db.session.commit()
        return jsonify({'message' : 'Exploit deleted Successfully'}), 200
    return jsonify({'message' : 'Exploit not found'}), 404